{# TODO: OLD set of macros to be removed #}

{# fingerprint a given class in a given graph #}
{% macro fingerprint_class_old(class, graph=None) -%}
    {% set from_statement = 'FROM <'~graph~'>' if graph else '' %}
    {% set select_query =
    "SELECT DISTINCT (?p as ?property)
        (GROUP_CONCAT(distinct ?tto; separator=', ') as ?object_type)
        (GROUP_CONCAT(distinct ?tp; separator=', ') as ?property_type)
        (count(distinct ?s) as ?subject_cnt)
        (count(distinct ?o) as ?object_cnt)
        (count(*) as ?pattern_cnt)
        (if(?subject_cnt < ?total_distinct_s, 0, min(?sp_star)) as ?min)
        (max(?sp_star) as ?max)
        (avg(?sp_star) * ?subject_cnt/?total_distinct_s as ?avg)
    "~from_statement~"
     WHERE {
        values ?ts {<"~class~">}
        ?s a ?ts .
        ?s ?p ?o .
        OPTIONAL { ?o a ?to . }
        # binding the Object and property types
        BIND(datatype(?o) as ?dto)
        BIND(IF(BOUND(?to),?to, IF (bound(?dto), ?dto, rdfs:Resource) ) as ?tto)
        BIND(IF(isURI(?o) || isBlank( ?o ) , owl:ObjectProperty , owl:DatatypeProperty) as ?tp)
        {
            select ?s ?p (count(*) as ?sp_star)
            {
                ?s ?p [] .
            }
            group by ?s ?p
        }
        {
            select ?ts (count(distinct ?i) as ?total_distinct_s)
            {
                ?i a ?ts
            }
            group by ?ts
        }
    }
    GROUP BY ?ts ?p ?total_distinct_s
    ORDER BY ?ts ?p ?total_distinct_s" %}
    {% set content, error = from_endpoint(conf.default_endpoint).with_query(select_query).fetch_tabular() %}
    {% set caller_ = caller %}
    {% call render_fetch_results(content, error) %}
        {% if not content.empty %}
            {{ caller_(content) }}
        {% endif %}
    {% endcall %}
{%- endmacro %}


{# render a class fingerprint #}
{% macro render_class_fingerprint_old(content, class_uri, graph_uri, inverted_prefixes) -%}
    {# fingerprint resultset signature #}
    {% set labels = {"property": "Property name",
    "object_type": "Object class",
    "property_type": "Property type",
    "subject_cnt": "Distinct Subjects",
    "object_cnt": "Distinct Objects",
    "pattern_cnt": "Occurences",
    "min": "Min",
    "max": "Max",
    "avg": "Avg",} %}

    {% set substituted_content = replace_strings_in_tabular(content,
                                    target_columns=['property','object_type','property_type'],
                                    value_mapping_dict=inverted_prefixes,
                                    mark_touched_rows=False ) %}
    {% set table_title = "The shape of <" + class_uri | safe + "> class instances" %}
    {{ render_pandas_table(content, table_title, column_labels=labels) }}
{%- endmacro %}

{# build fingerpring for each class in every graph from the endpoint #}
{% macro build_default_endpoint_fingerprint(inverted_prefixes=None) -%}
    {% call(graph) select_graphs() %}
        {% set graph_title = str(graph)[:10] %}
        <h2>{{ 'Named graph <...' + graph_title|safe + "> fingerprints" if graph else "Default graph fingerprints" }}</h2>
        <section>
            {% call(class) select_distinct_classes(graph) %}
                {% call(fingerprint_content) fingerprint_class(class) %}
                    {{ render_class_fingerprint(fingerprint_content, class, graph, inverted_prefixes) }}
                {% endcall %}
            {% endcall %}
        </section>
    {% endcall %}
{%- endmacro %}